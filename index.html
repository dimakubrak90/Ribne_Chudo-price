<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–°–∫–∞–Ω–µ—Ä —Ü—ñ–Ω</title>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #e0f7ff;
  }

  #priceDisplay {
    position: relative;
    padding: 20px;
    background: linear-gradient(to bottom right, #fff9e6, #e6f7ff);
    border-radius: 10px;
    border: 2px solid #0057b7;
    margin-top: 20px;
    overflow: hidden;
  }

  .controls { margin-top: 15px; }
  button { padding: 10px 15px; margin-right: 10px; }

  :root {
    --ok: #a8f3a8;
    --err: #ffb3b3;
  }

  input#barcode {
    width: 100%;
    font-size: 26px;
    padding: 12px;
    box-sizing: border-box;
  }

  .product-name { font-size: 30px; margin: 0; }
  .product-price {
    font-size: 48px;
    font-weight: bold;
    color: #0057b7;
    margin-top: 10px;
  }

  .muted { color: #666; font-size: 14px; }

  /* –ü—Å–µ–≤–¥–æ–µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –º–∏–≥–æ—Ç—ñ–Ω–Ω—è */
  #priceDisplay::before {
    content: "";
    position: absolute;
    inset: 0;
    z-index: 0;
    opacity: 0;
  }

  .flash-ok::before {
    animation: flashOk 3s ease;
  }

  .flash-err::before {
    animation: flashErr 3s ease;
  }

  @keyframes flashOk {
    0%   { background: var(--ok); opacity: 0.8; }
    50%  { background: #ffffff; opacity: 0.4; }
    100% { background: var(--ok); opacity: 0.8; }
  }

  @keyframes flashErr {
    0%   { background: var(--err); opacity: 0.8; }
    50%  { background: #ffffff; opacity: 0.4; }
    100% { background: var(--err); opacity: 0.8; }
  }

  /* –©–æ–± —Ç–µ–∫—Å—Ç –±—É–≤ –ø–æ–≤–µ—Ä—Ö –º–∏–≥–æ—Ç—ñ–Ω–Ω—è */
  #priceDisplay > * {
    position: relative;
    z-index: 1;
  }
</style>
</head>

<body>

<!-- –¶–µ–Ω—Ç—Ä–æ–≤–∞–Ω–∏–π –ª–æ–≥–æ—Ç–∏–ø -->
<div style="text-align:center;">
  <img src="logo.png" alt="–†–∏–±–Ω–µ —á—É–¥–æ" style="height:120px; max-width:90%; margin-bottom:10px;">
</div>

<h2>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–Ω–∏</h2>

<input
  id="barcode"
  type="text"
  placeholder="–°–∫–∞–Ω—É–π—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥"
  autofocus
  autocomplete="off"
  autocapitalize="off"
/>

<div id="loadingInfo" class="muted" style="margin-top:10px;"></div>

<div class="controls">
  <button id="updateCacheBtn">–û–Ω–æ–≤–∏—Ç–∏ –±–∞–∑—É</button>
  <button id="clearCacheBtn">–û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à</button>
  <div>–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <span id="lastUpdate">–Ω–µ–º–∞—î</span></div>
</div>

<div id="priceDisplay">
  <h3 id="productName" class="product-name">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</h3>
  <p id="productPrice" class="product-price">–¶—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é (–æ–ø—Ç)</p>
</div>

<audio id="beep" preload="auto">
  <source src="beep.wav" type="audio/wav">
</audio>
<script>
(function () {
  const SCRIPT_URL =
    'https://script.google.com/macros/s/AKfycbwZP14KXpQPgRCzR-ITop_yPcyOqXV0MKJt6uLK-HkKEwD7juo71zcJfNbycTB2X6ofWg/exec';

  const CACHE_KEY = 'p_cache_v1';
  const CACHE_TS_KEY = 'p_cache_ts_v1';
  const DAY_MS = 24 * 60 * 60 * 1000;

  const input = document.getElementById('barcode');
  const nameEl = document.getElementById('productName');
  const priceEl = document.getElementById('productPrice');
  const loadingInfo = document.getElementById('loadingInfo');
  const lastUpdateEl = document.getElementById('lastUpdate');
  const priceBox = document.getElementById('priceDisplay');
  const updateBtn = document.getElementById('updateCacheBtn');
  const clearBtn = document.getElementById('clearCacheBtn');
  const beep = document.getElementById('beep');

  function normalizeCode(code) {
    return String(code).replace(/[\s\r\n]+/g, '').trim();
  }

  function searchInCache(code) {
    try {
      const map = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
      return map[normalizeCode(code)] || null;
    } catch {
      return null;
    }
  }

  function renderLastUpdate() {
    const ts = localStorage.getItem(CACHE_TS_KEY);
    lastUpdateEl.textContent =
      ts ? new Date(Number(ts)).toLocaleString() : '–Ω–µ–º–∞—î';
  }

  function playBeep() {
    try { beep.play().catch(() => {}); } catch {}
  }

  // –ü–æ–∫–∞–∑ –ø—Ä–æ–¥—É–∫—Ç—É –∑ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è–º –ø–æ–≤–µ—Ä—Ö –≥—Ä–∞–¥—ñ—î–Ω—Ç–∞ (3 —Å–µ–∫—É–Ω–¥–∏)
  function showProduct(product) {
    if (product) {
      nameEl.textContent = product.name;
      priceEl.textContent = `–¶—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é (–æ–ø—Ç): ${product.price} –≥—Ä–Ω`;
      playBeep();

      priceBox.classList.remove('flash-ok', 'flash-err');
      void priceBox.offsetWidth;
      priceBox.classList.add('flash-ok');
    } else {
      nameEl.textContent = '‚ùå –¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
      priceEl.textContent = '';

      priceBox.classList.remove('flash-ok', 'flash-err');
      void priceBox.offsetWidth;
      priceBox.classList.add('flash-err');
    }
  }

  async function loadCache(force = false) {
    try {
      const ts = localStorage.getItem(CACHE_TS_KEY);
      const now = Date.now();

      if (!force && ts && now - Number(ts) < DAY_MS) {
        loadingInfo.textContent = '‚úÖ –ë–∞–∑–∞ –∑ –∫–µ—à—É';
        setTimeout(() => (loadingInfo.textContent = ''), 1200);
        renderLastUpdate();
        return;
      }

      loadingInfo.textContent = '‚è≥ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏...';

      const res = await fetch(SCRIPT_URL, { cache: 'no-store' });
      const data = await res.json();
      const products = Array.isArray(data.products) ? data.products : [];

      const map = {};
      products.forEach(p => {
        if (p.barcode) {
          map[normalizeCode(p.barcode)] = {
            name: String(p.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏'),
            price: String(p.price || '')
          };
        }
      });

      localStorage.setItem(CACHE_KEY, JSON.stringify(map));
      localStorage.setItem(CACHE_TS_KEY, String(Date.now()));

      loadingInfo.textContent = `‚úÖ –ë–∞–∑–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞ (${Object.keys(map).length})`;
      renderLastUpdate();
      setTimeout(() => (loadingInfo.textContent = ''), 2000);
    } catch {
      loadingInfo.textContent = '‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
      setTimeout(() => (loadingInfo.textContent = ''), 3000);
    }
  }

  // –ü–æ–∫–∞–∑ –ª–∏—à–µ –æ–¥–∏–Ω —Ä–∞–∑: —Å–ø–æ—á–∞—Ç–∫—É –∫–µ—à; —Å–µ—Ä–≤–µ—Ä —Ç–∏—Ö–æ –æ–Ω–æ–≤–ª—é—î –∫–µ—à
  function handleScan() {
    const code = normalizeCode(input.value);
    input.value = '';
    input.focus();
    if (!code) return;

    console.log('SCAN:', code);

    const cached = searchInCache(code);
    showProduct(cached);

    fetch(`${SCRIPT_URL}?barcode=${encodeURIComponent(code)}`, { cache: 'no-store' })
      .then(r => r.json())
      .then(data => {
        const p = data?.data;
        if (!p || (!p.name && !p.price)) return;

        const product = {
          name: String(p.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏'),
          price: String(p.price || '')
        };

        const map = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
        map[normalizeCode(code)] = product;
        localStorage.setItem(CACHE_KEY, JSON.stringify(map));
      })
      .catch(() => {});
  }

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleScan();
    }
  });

  updateBtn.onclick = () => loadCache(true);

  clearBtn.onclick = () => {
    localStorage.removeItem(CACHE_KEY);
    localStorage.removeItem(CACHE_TS_KEY);
    renderLastUpdate();
    loadingInfo.textContent = 'üóëÔ∏è –ö–µ—à –æ—á–∏—â–µ–Ω–æ';
    setTimeout(() => (loadingInfo.textContent = ''), 1200);
  };

  (function init() {
    if (!localStorage.getItem(CACHE_KEY)) {
      localStorage.setItem(CACHE_KEY, '{}');
    }
    renderLastUpdate();
    loadCache(false);
    input.focus();
  })();
})();
</script>
</body>
</html>
