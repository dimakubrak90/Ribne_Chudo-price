<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Перевірка ціни</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f2f2f2;
      margin: 0;
    }

    h2 {
      margin-top: 0;
    }

    #priceDisplay {
      padding: 25px;
      background: #fff;
      border-radius: 10px;
      margin-top: 20px;
      transition: background-color 0.3s;
    }

    :root {
      --ok: #a8f3a8;
      --err: #ffb3b3;
    }

    input#barcode {
      width: 100%;
      font-size: 26px;
      padding: 12px;
      box-sizing: border-box;
      border-radius: 8px;
      border: 2px solid #f5b400;
      outline: none;
    }

    .controls {
      margin-top: 15px;
    }

    button {
      padding: 10px 15px;
      font-size: 16px;
      margin-right: 10px;
    }

    .product-name {
      font-size: 30px;
      margin: 0;
    }

    .product-price {
      font-size: 24px;
      color: #0057b7;
      margin-top: 10px;
    }

    .muted {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>

<body>

  <h2>Перевірка ціни</h2>

  <!-- ВАЖЛИВО: readonly + inputmode=none -->
  <input
    id="barcode"
    type="text"
    placeholder="Скануйте штрихкод"
    autocomplete="off"
    autocapitalize="off"
    inputmode="none"
    readonly
  >

  <div class="controls">
    <button id="updateCacheBtn">Оновити базу</button>
    <button id="clearCacheBtn">Очистити кеш</button>
    <div class="muted">
      Останнє оновлення: <span id="lastUpdate">немає</span>
    </div>
  </div>

  <div id="priceDisplay">
    <h3 id="productName" class="product-name">Назва товару</h3>
    <div id="productPrice" class="product-price">Ціна</div>
  </div>

  <div id="loadingInfo" class="muted"></div>

  <audio id="beep" preload="auto">
    <source src="beep.wav" type="audio/wav">
  </audio>
<script>
(function () {

  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZP14KXpQPgRCzR-ITop_yPcyOqXV0MKJt6uLK-HkKEwD7juo71zcJfNbycTB2X6ofWg/exec';
  const CACHE_KEY = 'price_cache';
  const CACHE_TS_KEY = 'price_cache_ts';
  const DAY_MS = 24 * 60 * 60 * 1000;

  const input = document.getElementById('barcode');
  const nameEl = document.getElementById('productName');
  const priceEl = document.getElementById('productPrice');
  const priceBox = document.getElementById('priceDisplay');
  const updateBtn = document.getElementById('updateCacheBtn');
  const clearBtn = document.getElementById('clearCacheBtn');
  const lastUpdateEl = document.getElementById('lastUpdate');
  const loadingInfo = document.getElementById('loadingInfo');
  const beep = document.getElementById('beep');

  let isScanning = false;
  let scanTimer = null;

  function normalize(code) {
    return String(code || '').replace(/[\s\r\n]+/g, '').trim();
  }

  function forceFocus() {
    setTimeout(() => {
      input.focus();
      input.click();
    }, 100);

    setTimeout(() => {
      input.focus();
    }, 500);
  }

  input.addEventListener('focus', () => {
    input.removeAttribute('readonly');
  });

  input.addEventListener('blur', () => {
    input.setAttribute('readonly', 'readonly');
  });

  function playBeep() {
    try {
      beep.currentTime = 0;
      beep.play();
    } catch (e) {}
  }

  function renderLastUpdate() {
    const ts = localStorage.getItem(CACHE_TS_KEY);
    if (!ts) return;
    lastUpdateEl.textContent = new Date(+ts).toLocaleString();
  }

  async function loadCache(force = false) {
    const ts = localStorage.getItem(CACHE_TS_KEY);
    const now = Date.now();

    if (!force && ts && (now - ts < DAY_MS)) {
      renderLastUpdate();
      forceFocus();
      return;
    }

    loadingInfo.textContent = 'Завантаження бази...';

    try {
      const res = await fetch(SCRIPT_URL + '?all=1', { cache: 'no-store' });
      const data = await res.json();
      const map = {};

      (data.products || []).forEach(p => {
        if (p.barcode) {
          map[normalize(p.barcode)] = {
            name: p.name || 'Без назви',
            price: p.price || ''
          };
        }
      });

      localStorage.setItem(CACHE_KEY, JSON.stringify(map));
      localStorage.setItem(CACHE_TS_KEY, Date.now());
      renderLastUpdate();
      loadingInfo.textContent = '';
      forceFocus();

    } catch (e) {
      loadingInfo.textContent = 'Помилка оновлення';
    }
  }

  function showProduct(p) {
    if (p) {
      nameEl.textContent = p.name;
      priceEl.textContent = 'Ціна: ' + p.price + ' грн';
      priceBox.style.backgroundColor = 'var(--ok)';
      playBeep();
    } else {
      nameEl.textContent = '❌ Товар не знайдено';
      priceEl.textContent = '';
      priceBox.style.backgroundColor = 'var(--err)';
    }

    setTimeout(() => {
      priceBox.style.backgroundColor = '#fff';
    }, 600);
  }

  async function handleScan() {
    if (isScanning) return;
    isScanning = true;

    const code = normalize(input.value);
    input.value = '';

    if (!code) {
      isScanning = false;
      forceFocus();
      return;
    }

    const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');

    if (cache[code]) {
      showProduct(cache[code]);
    } else {
      showProduct(null);
    }

    try {
      const res = await fetch(SCRIPT_URL + '?barcode=' + encodeURIComponent(code));
      const data = await res.json();

      if (data?.data) {
        showProduct(data.data);
        cache[code] = data.data;
        localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
      }
    } catch {}

    isScanning = false;
    forceFocus();
  }

  input.addEventListener('input', () => {
    clearTimeout(scanTimer);
    scanTimer = setTimeout(handleScan, 40);
  });

  updateBtn.onclick = () => loadCache(true);
  clearBtn.onclick = () => {
    localStorage.clear();
    lastUpdateEl.textContent = 'немає';
    forceFocus();
  };

  (function init() {
    if (!localStorage.getItem(CACHE_KEY)) {
      localStorage.setItem(CACHE_KEY, '{}');
    }
    renderLastUpdate();
    loadCache(false);
    forceFocus();
  })();

})();
</script>

</body>
</html>
